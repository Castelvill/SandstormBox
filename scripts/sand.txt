start onInit
triggers on_init
//env window_size 1366 568
//edit_proc window_size 1366 568
env window_size 1366 768//640 480//1920 1080
edit_proc window_size 1920 1080
edit_proc draw_camera_borders 1

load_bitmap "images/background2.png" background2
load_bitmap "images/background3.png" background3
load_bitmap "images/amongus1.png" amongus1
load_bitmap "images/amongus2.png" amongus2
load_bitmap "images/amongus3.png" amongus3
load_bitmap "images/terry.png" terry
load_bitmap "images/arch.jpg" arch
load_bitmap "images/cobblestone.png" cobblestone
load_bitmap "images/elephant.jpg" elephant

value ([window_w]) ww
value ([window_h]) wh

new camera l 1 _ _ Cam
//fun Cam set_position int [100 100]
fun Cam set_id string [Desktop]
fun Cam set_active bool [true]
fun Cam resize c ww c wh
fun Cam set_zoom double [1.0]
fun Cam set_speed double [20]
fun Cam set_key_zoom_in int [15]
fun Cam set_key_zoom_out int [21]
fun Cam set_zoom_increase double [0.02]
fun Cam add_visible_layer string [KERNEL]
fun Cam add_accessible_layer string [KERNEL]
fun Cam set_tint double [1.0 1.0 1.0 1.0]
fun Cam set_can_move_with_mouse bool [1]
fun Cam set_can_zoom_with_mouse bool [0]
fun Cam set_can_move_with_keyboard bool [0]
fun Cam set_can_zoom_with_keyboard bool [0]
fun Cam set_drawing_borders bool [0]

new image c me 1 _ _ background
//fun background deactivate
fun background connect_bitmap_via_alias string [background2]
fun background attach_to_camera
fun background resize c ww c wh
fun background set_color double [0.5 0.5 0.5 0.5]

int [640] windowSizeX
int [480] windowSizeY
int [0 0] editableTextPos

new editable_text c me 1 _ _ TerminalTextField
//fun TerminalTextField attach_to_camera
fun TerminalTextField set_id string [edi]
fun TerminalTextField set_position c editableTextPos
fun TerminalTextField set_font string [fira_mono24]
fun TerminalTextField set_wrapping int [0]
fun TerminalTextField set_editable bool [1]
fun TerminalTextField set_space_use bool [1]
fun TerminalTextField set_max_content_length int [10000]
fun TerminalTextField add_new_and_update string ["Welcome in Sandstorm Box terminal!"]
fun TerminalTextField set_size int [1920 1080]
fun TerminalTextField select_layer int [1]
fun TerminalTextField set_color double [0.0 1.0 0.0 1.0]
fun TerminalTextField set_input_delay double [0.3]
fun TerminalTextField set_repetition_delay double [0.05]
fun TerminalTextField set_use_tabs bool [1]
fun TerminalTextField set_enter_use bool [0]
fun TerminalTextField set_can_enter_accept bool [0]
fun TerminalTextField set_protected_area int [37]

new editable_text c me 1 _ _ TextEditor
clone TextEditor TerminalTextField
fun TextEditor set_protected_area int [0]
fun TextEditor set_enter_use bool [1]
fun TextEditor set_text int [0] string [""]
fun TextEditor deactivate

var string "_enter" program
var string "" param0
var string "" param1
var string "" param2
var string "" param3
var string "" param4
var string "" param5
var string "" param6
var string "" param7

var int 10 roundingSize

end


start interrupt
triggers key_pressed
if ([key_pressed 215] [key_pressed 3] &&) //217-c, 215-shift, 3-c
string [""] program
end



start controler
triggers each_iteration
if ([context program] [string ""] ==)
string ["$ "] result
string ["sleep"] program
run printOnTerminal
end

start controlerWithEnter
triggers each_iteration
if ([context program] [string "_enter"] ==)
string ["\n$ "] result
string ["sleep"] program
run printOnTerminal
end





start fs_click false
triggers key_pressed
if ([key_pressed 58])
run setFullscreen
end

start fullscreen false
string [""] program
run setFullscreen
end

start fs false
string [""] program
run setFullscreen
end

start setFullscreen false
if ([fullscreen] !)
env fullscreen 1
else fs_else
end

start fs_else false
env fullscreen 0
end

start refresh false
triggers on_display_resize
if([on_display_resize])
value ([window_w]) w
value ([window_h]) h
index camera [0] _ camera Cam0
fun Cam0 resize c w c h
index context me [0 0] _ image background
fun background resize c w c h

index layer [0 1] _ object Terminal
index context Terminal [0 0] _ editable_text EditableText
fun EditableText set_size c w c h
end



start enter
triggers key_pressed
if ([key_pressed 67] [context program] [string "sleep"] == &&)

index layer [0 1] _ object Terminal
index context Terminal [0 0] _ editable_text EditableText
first _ [EditableText] _ _ _ _ content _ userInput
first _ [EditableText] _ _ _ _ protected_area _ protectedArea
len userInput userInputSize
substr userInput protectedArea userInputSize command

string [""] param0
string [""] param1
string [""] param2
string [""] param3
string [""] param4
string [""] param5
string [""] param6
string [""] param7

tokenize command param0 param1 param2 param3 param4 param5 param6 param7

string [neofetch help hello sq cats sh fullscreen fs spawn 222 cls cat print exit edit sand] allowedPrograms
in param0 allowedPrograms isAllowed
string ["_enter"] program
run programCheck
end

start programCheck
if ([context isAllowed])
string ["run "] run
+= run param0
string ["run"] program
inject_instr me run
string ["\n"] result
run printOnTerminal
else programNotFound
end

start programNotFound
if ([context param0] [string ""] !=)
string ["\nCommand not found!"] result
run printOnTerminal
end


start printOnTerminal
index layer [0 1] _ object Terminal
index context Terminal [0 0] _ editable_text EditableText
int [0] zero
//fun EditableText add_text int [0] string ["\n"]
fun EditableText add_text context zero context result
first _ [EditableText] _ _ _ _ content _ history
len history historySize
fun EditableText set_protected_area c historySize
fun EditableText set_cursor_pos c historySize
end



start edit
string ["edit"] program
index layer [0 1] _ object Terminal
index context Terminal [0 0] _ editable_text TerminalTextField
fun TerminalTextField deactivate
index context Terminal [0 1] _ editable_text TextEditor
fun TextEditor set_text int [0] string [""]
fun TextEditor set_cursor_pos int [0]
fun TextEditor activate
run loadTextFromFile
end

start loadTextFromFile
if ([context param1] [string ""] !=)
load_text param1 loadedText
int [0] 0
fun TextEditor set_text c 0 c loadedText
len loadedText loadedTextSize
fun TextEditor set_cursor_pos c loadedTextSize
end

start textEditorControler
triggers key_pressed
if([context program] [string "edit"] == [key_pressed 217] && [key_pressed 17] &&)
string [""] program
index layer [0 1] _ object Terminal
index context Terminal [0 0] _ editable_text TerminalTextField
fun TerminalTextField activate
index context Terminal [0 1] _ editable_text TextEditor
fun TextEditor deactivate
end

start textEditorControler
triggers key_pressed
if([context program] [string "edit"] == [key_pressed 217] && [key_pressed 19] &&)
index layer [0 1] _ object Terminal
index context Terminal [0 1] _ editable_text TextEditor
first _ [TextEditor] _ _ _ _ content _ writtenText
save_text param1 writtenText
end

start sand
load_build me param1
string [""] program
end